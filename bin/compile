#!/bin/bash

# Directories provided by Heroku
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# cd .. 
buildpack_dir=$(cd "$(dirname "$1")"; cd ..; pwd)

echo "-----> Setting up Go environment"
GO_VERSION="1.21.0"
GO_TAR="go${GO_VERSION}.linux-amd64.tar.gz"
GO_URL="https://golang.org/dl/${GO_TAR}"

# Download and install Go
curl -sL ${GO_URL} -o /tmp/${GO_TAR}
tar -C /tmp -xzf /tmp/${GO_TAR}
mv /tmp/go $buildpack_dir/.go

# Add Go to PATH
export PATH=$buildpack_dir/.go/bin:$PATH

echo "-----> Building Go application in root directory"
cd $buildpack_dir
go mod tidy
go build -o $buildpack_dir/bin/app .

echo "-----> Build complete. The binary is in $buildpack_dir/bin/app"
